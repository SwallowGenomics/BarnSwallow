#1. decontamination by adapters on HiFi raw reads. Example on sample A1:

cutadapt -b "AAAAAAAAAAAAAAAAAATTAACGGAGGAGGAGGA;min_overlap=35" -b "ATCTCTCTCTTTTCCTCCTCCTCCGTTGTTGTTGTTGAGAGAGAT;min_overlap=45" --discard-trimmed -o A1_trimmed.ccs.fq A1.ccs.fq -j 32 --revcomp -e 0.01

#2. Assembly with Hifiasm. Example on sample A1:

hifiasm -o A1.ccs.asm -t 32 A1_trimmed.ccs.fq

#3. Separate primary and alternate assemblies. Example on sample A1:

#3.1. primary
awk '/^S/{print ">"$2;print $3}' A1_trimmed.ccs.asm.p_ctg.gfa > A1_primary.fasta 
#3.2. alternate
awk '/^S/{print ">"$2;print $3}' A1_trimmed.ccs.asm.a_ctg.gfa > A1_alternate.fasta 

#4. run merqury to generate the Meryl database with the _submit_build.sh script included in the package modified according to your cluster. The script can be found here https://github.com/marbl/merqury/blob/master/_submit_build.sh . Example with sample A1 raw reads:

bash _submit_build_mod.sh 21 input_A1.fofn A1 

#5. run Genomescope2.0 online (http://qb.cshl.edu/genomescope/genomescope2.0/) with 31 k-mers, uploading the .histo file outputted by the previous script.

#6. run purge dups with custom cutoffs for HiFi reads.The scripts can be found here https://github.com/VGP/vgp-assembly/tree/master/pipeline/purge_dups

#6.1. add the -xasm20 option for HiFi reads to minimap2.sh and minimap2_self.sh 

#6.2. calculate custom cutoffs starting from the kcov computed by Genomescope2.0. Esample on sample A1: 

#kcov by Genomescope 2.0 = 16.5 
#value1 = kcov*1.5 = 24.75
#value2 = value1*3 = 74.25

#modify the script purge_dups.sh with the custom cutoffs:
calcuts -m 24.75 -u 74.25 PB.stat > cutoffs 2>calcults.log   

#add the modified minimap2.sh, minimap2_self.sh and purge_dups.sh scripts into _submit_purge_dups.sh and run it like this:

bash _submit_purge_dups.sh A1_primary.fasta input.fofn  #example on sample A1 primary. Repeat also for alternate assemblies.

#7. run asm_stats.sh to obtain statistics before and after purging. Example on A1:

asm_stats.sh A1_primary.fasta 1060419062 c #the genome size is the mean predicted size from Genomescope2.0
asm_stats.sh A1_primary_purged.fasta 1060419062 c

#8. soft-mask the purged genomes. Example of sample A1 primary:

#8.1. windowmasker
windowmasker -mk_counts -in A1_primary_purged.fasta -out stage1_A1p.counts 
windowmasker -ustat stage1_A1p.counts -in A1_primary_purged.fasta -outfmt fasta -out A1_primary_purged_winmask.fasta 

#8.2. EepeatMasker
RepeatMasker -pa 32 -xsmall -species aves A1_primary_purged.fasta -dir .

#8.3. use the RepeatMasker .out file to generate a .bed file with repeats coordinates. Use this file to maske the windowmasker-masked genome:

bedtools maskfasta -soft -fi A1_primary_purged_winmask.fasta -bed A1_primary_purged_REPMASK_REPEATS.bed -fo A1_primary_purged_masked.fasta 
